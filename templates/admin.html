{% extends "base.html" %}
{% block title %}Admin Panel - Chuck E Sync{% endblock %}

{% block extra_css %}
  <link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="admin-page">

  <div class="admin-card">
    <a href="{{ url_for('main.index') }}" class="back-link">‚Üê Back to Home</a>

    <h1>Admin Panel</h1>

    <p><strong>Next sync in:</strong> <span id="sync-timer">Loading...</span></p>

    {% for user in users %}
    <div class="user-entry">
      <div class="user-email">
        {{ user['email'] }}
        {% if user['is_admin'] %}
          <span class="badge bg-warning text-dark">Admin</span>
        {% endif %}
      </div>
      <div class="user-actions">
        <form method="post" action="/test_user/{{ user['email'] }}">
          <button class="btn btn-outline-primary btn-sm" onclick="return confirm('Test sync for {{ user.email }}?')">Test Sync</button>
        </form>
        <form method="post" action="/clear_user/{{ user['email'] }}">
          <button class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete {{ user.user-email }} from the system?')">Delete</button>
        </form>
        <form method="post" action="/toggle_admin/{{ user['email'] }}">
          <button class="btn btn-outline-warning btn-sm">Toggle Admin</button>
        </form>
        <form method="post" action="/sync_user_calendar/{{ user['email'] }}">
          <button class="btn btn-outline-warning btn-sm">Sync</button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="log-container">
    <strong>Server Logs:</strong>
    <pre>{{ logs|safe }}</pre>
  </div>

  <form class="command-bar" method="post">
    <input name="command" type="text" placeholder="Enter a Python or SQL command..." required>
    <button type="submit" class="btn btn-success" formaction="/exec_command">Run Python</button>
    <button type="submit" class="btn btn-warning" formaction="/run_sql">Run SQL</button>
  </form>

</div>

{% block extra_js %}
<script>
  // eslint-disable-next-line
  const syncEpoch = Number('{{ next_sync_epoch }}');
  function updateTimer() {
    const now = Math.floor(Date.now() / 1000);
    const remaining = Math.max(syncEpoch - now, 0);
    const minutes = Math.floor(remaining / 60);
    const seconds = remaining % 60;
    document.getElementById('sync-timer').textContent = `${minutes}m ${seconds}s`;
  }
  setInterval(updateTimer, 1000);
  updateTimer();
</script>
{% endblock %}
{% endblock %}
