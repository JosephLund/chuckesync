{% extends "base.html" %}
{% block title %}Admin Panel - Chuck E Sync{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/admin.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="admin-page" data-next-sync="{{ next_sync_epoch }}">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="admin-card">
        <a href="{{ url_for('main.index') }}" class="back-link">← Back to Home</a>

        <h1>Admin Panel</h1>

        <p><strong>Next sync in:</strong> <span id="sync-timer">Loading...</span></p>

        {% for user in users %}

        {% set is_protected = user['email'] == protected_email %}
        <div class="user-entry">
          <div class="user-meta mb-2">
            <strong>{{ user['email'] }}</strong>
            {% if user['is_admin'] %}
            <span class="badge bg-warning text-dark">Admin</span>
            {% endif %}
          </div>
          <div class="user-actions d-flex flex-wrap gap-2">
            <button class="btn btn-outline-info btn-sm" data-user='{{ user | tojson | safe }}'
              onclick='showUserInfo(this.dataset.user)'>
              Info
            </button>

            <form method="post" action="/clear_user/{{ user['email'] }}">
              <button class="btn btn-outline-danger btn-sm">
                Delete
              </button>
            </form>

            <form method="post" action="/toggle_admin/{{ user['email'] }}">
              <button class="btn btn-outline-warning btn-sm">
                Toggle Admin
              </button>
            </form>
            <form method="post" action="/sync_user_calendar/{{ user['email'] }}">
              <button class="btn btn-outline-warning btn-sm">
                Sync
              </button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

    </div>
  </div>
  <div class="log-section-wrapper" id="logSection">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <strong>Server Logs:</strong>
      <button id="terminal-toggle" type="button" class="btn btn-secondary btn-sm">
        ⤢ Toggle Fullscreen
      </button>
    </div>

    <div class="log-container" id="logContainer">
      <div class="log-list">
        {% for log in logs %}
        <div class="log-entry log-{{ log.level | lower }}">
          <div class="log-meta">
            <strong>{{ log.level }}</strong>
            <span class="timestamp">{{ log.timestamp | logtime(user_timezones.get(log.user, "UTC")) }}</span>
            {% if log.user %}<span class="log-user">{{ log.user }}</span>{% endif %}
          </div>
          <div class="log-message">{{ log.message }}</div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <div class="terminal-output">
      {% for message in messages %}
      <div class="terminal-line">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    {% endwith %}
    <form class="command-bar" method="post" action="/exec_command">
      <input name="command" type="text" placeholder="Enter a command..." required>
      <button type="submit" class="btn btn-success">Run</button>
    </form>

  </div>

  <div id="user-info-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" onclick="hideModal()">&times;</span>
      <h2 id="modal-user-email" class="mb-3"></h2>

      <table class="table table-striped">
        <tbody id="user-info-table"></tbody>
      </table>

      <div class="d-flex justify-content-end">
        <a id="download-logs-btn" class="btn btn-sm btn-outline-secondary" href="#" download>
          Download Logs
        </a>
      </div>
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
  {% endblock %}